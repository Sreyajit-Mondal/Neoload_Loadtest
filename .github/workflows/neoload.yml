name: NeoLoad Github Action Test

on:
  workflow_dispatch:
    inputs:
      api_url:
        required: true
        description: 'NeoLoad Web API URL'
        default: 'https://neoload-api.saas.neotys.com/'
      token:
        required: true
        description: 'NeoLoad Web Token'
        default: 'specify_token_or_get_it_from_credentials'
      zone_id:
        required: true
        description: 'Zone identifier'
        default: 'defaultzone'

jobs:
  neoload_cli_demo:
    name: NeoLoad CLI demo github action
    runs-on: ubuntu-latest

    steps:
      - name: Checkout local code
        uses: actions/checkout@v4

      - name: "Install NeoLoad CLI"
        run: pip3 install -U neoload

      - name: "Get NeoLoad YAML project"
        run: |
          rm -f *.yml
          wget https://raw.githubusercontent.com/Sreyajit-Mondal/Neoload_Loadtest/main/simpledemo.yml

      - name: "Login and upload project"
        run: |
          neoload login --url ${{ github.event.inputs.api_url }} ${{ github.event.inputs.token }}
          neoload test-settings --zone ${{ github.event.inputs.zone_id }} --scenario 'simpledemo' createorpatch "My Github Test With CLI"
          neoload project --path simpledemo.yml upload

      - name: "Run NeoLoad test"
        id: run_test
        run: |
          neoload run \
            --external-url $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID \
            --external-url-label "Github Action Run $GITHUB_RUN_NUMBER" \
            --name "Github pipeline performance regression test - Github build #$GITHUB_RUN_NUMBER" \
            --description "Example of CI performance regression job started from Github." \
            --return-0 > output.log

          echo "TEST_RESULT_ID=$(grep -oP 'test result id: \K[0-9a-f\-]+' output.log)" >> $GITHUB_ENV

      - name: "Generate Test Report"
        id: report
        if: ${{ always() }}
        run: neoload test-results junitsla ${{ env.TEST_RESULT_ID }}

      - name: "Publish Test Report"
        if: steps.report.outcome == 'success'
        uses: scacap/action-surefire-report@v1
        with:
          report_paths: junit-sla.xml
          fail_on_test_failures: true
